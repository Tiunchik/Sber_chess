## Sber_chess

[![Build Status](https://travis-ci.org/Tiunchik/Sber_chess.svg?branch=master)](https://travis-ci.org/Tiunchik/Sber_chess)

### Задача:
#### Шахматисты. Школы. Рейтинги Эло. 
#####    1. Spring. WEB-приложение. БД.
* Каждые 30 секунд проводится партия между двумя случайными шахматистами разных школ. По результату (победитель выбирается случайным образом) рассчитывается их рейтинг Эло;
* Для шахматистов CRD (Из слова CRUD). R в виде списка;
* Отображение списка пяти шахматистов с лучшим изменением рейтинга за последние 5 минут;
#####    2. Библиотека для мониторинга(jar) содержит в себе и обрабатывает аннотацию @Monitoring(“EVENT_NAME")
* Подключить во все «важные» методы приложения, которое обсуждалось выше в пункте 1.
* Аннотация собирает 3 метрики по методу: факт входа в метод (…_START), факт завершения метода (…_END), длительность выполнение метода в миллисекундах(…_DURATION)

### Инструкция по сборке и запуску приложения:
1. Приложение для сборки требует скачивание двух проектов:
Само приложение - https://github.com/Tiunchik/Sber_chess 
Библиотека аннотаций - https://github.com/Tiunchik/library
2. Необходимо произвести сборку библиотеки аннотаций
3. В файле pom.xml основного приложения, в строке <systemPath>${user.home}/projects/testasks/Library/target/library-1.0.jar</systemPath> задать путь до собранного файла jar библиотеки аннотаций
4. В файле application.properties задать указание на PostgreSQL (IP + порт), которую будет использовать проект, предварительно создав там БД для проекта, по дефолту - chess, задать пароль для пользователя postgresql
5. При отсутствии установленной psql - установить, задать порт 5432, пароль - password, либо удобные Вам, но в дальнейшем повторить пункт 3
6. Произвести сборку приложения, запустить.
#### После установки удалённого репозитория, необходимо выполнять только пункт 1, в части самого приложения и пункты 4,5,6

### Тайм-лог:
* 1,5 часа на создание каркаса приложения, создание моделей, контроллеров, интерфейсов Jpa, создание скриптов для liquebase
* 1,5 часа на чтение про рейтинг ЭЛО, написание упрощённого алгоритма вычислений, если будет время - необходимо усложнить алгоритм до настоящего (расчёт К, вариант с ничьёй)
* 0,5 часа - добавлены базовые игроки и школы, загружаемые через liquibase при первом старте программы, поправлена ошибка в PlayerRepository
* 1 час - переписана логика подсчёта рейтинга ЭЛО, устранены ошибки, добавлена возможность ничьи, откорректировал сущность Game, изначально содержала отдельное поле победителя. Удалил, теперь на первое место всегда ставиться игрок победитель
* 1 час на написание запроса выполняющего отображение списка пяти шахматистов с лучшим изменением рейтинга за последние 5 минут.
* 2 часа разборок с timestamp в sql и java и некорректности задачи временной зоны в hibernate и консоли. Не решён вопрос, почему в hibernate перестал нормально работать fetch
* 0,5 часа на решение вопроса с fetch - lazy в зависимости ManyToOne.
* 4 часа на попытки организовать собственный Proxy через BPP. Основная проблема, как я понимаю, что в spring boot у бинов имена уже не так используются, и моя замена бина приводила к тому, что контекст больше его не мог найти. Метод в бине запускался через Scheduler, но ошибка до меня не доходила.
* 2 часа на знакомство с Spring AOP, создание работающей аннотации
* 1,5 часа на создание сущности, репозитория, добавления их в liquibase, так как поднятие на базе hibernate мне не нравиться, знакомство с jointpoint классом и вытаскиванием из него значений аргументов.
* 2 часа на попытку прикрутить отдельный jar, не хотел искать нормально классы
* 1,5 часа на перенос отдельного jar как модуля и на разборки, почему не ищет классы в модуле, использовал @ComponentScan, @EntityScan, пробовал составить конфиг. В итоге просто прописал @SpringBootApplication(scanBasePackages = {"org.chess.*"}). Основной ошибкой было некорректная хэш функция у класса MonitorEvent, он не создавался и не собирался репозиторий, не работало подключение. Как понимаю, если бы не было этой проблемы, то и jar подключился бы через scanBasePackages без особых проблем
* 1 час на то что бы подружить spring с jar файлом, вписанным как зависимость в pom.xml
##### Итого: ориентировочно 20 часов на выполнение тестового задания.

### Дополнительно, после сдачи задания, сделано:
* 0,5 часа на добавление [thin](https://www.baeldung.com/spring-boot-thin-jar) плагина к spring-maven сборщику (см блок plugins в Pom.xml), после mbv clean install файл проекта был уменьшен с 39 мегабайт до 27 килобайт!
* 0,5 часа на перенос локальной зависимости на удалённую, с помощью [jipack](https://jitpack.io/)
* 1 час на добавление файла .travis.yml для выгрузки на проверку в travis, а так же двух профилей: dev, с функцией автоматической перекомпиляции в ходе работы и test, установленного по умолчанию, что бы проходить проверку на отсутсвие пароля в БД PSQL на travis
* 1,5 часа на рефакторинг, добавлен слой сервисов, добавлены DTO, все действия теперь проходят через слой сервисов
* 1,5 часа на решение вопроса с автоконфигурацией для Library, без дополнительных аннотаций
* TODO - доработать сервис ChessGameService. При сохранении сторонних игр, удалении уже записанных и их обновлении не происходят изменения рейтинга в таблице игроков.
